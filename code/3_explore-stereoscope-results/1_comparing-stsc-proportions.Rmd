---
title: "comparing_stsc_proportions"
author: "Javier Escudero"
date: "2023-03-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading libraries

```{r}
rm(list=ls())

library(semla)
library(ggplot2)
library(readxl)
library(ggridges)
library(patchwork)
library(RColorBrewer)
library(viridis)
library(tidyverse)
```

Setting directories

```{r}
st.dir <- "your path to the visium spaceranger outs"
stsc.dir <- "your path to the stereoscope results"
vis.dir <- "your path to where to export the results"
```

# Analysis

## Loading ST data
```{r}
create_infoTable <- function(data.dir, tissue) {
  
  data_dir <- paste0(data.dir,"/",tissue)
  infoTable <- data.frame(samples = list.files(data_dir, full.names = TRUE, recursive = TRUE, 
                                               pattern = "^filtered.+.h5$"),
                          spotfiles = list.files(data_dir,
                                                 full.names = TRUE, recursive = TRUE, 
                                                 pattern = "positions_list.csv$"),
                          imgs = list.files(data_dir ,recursive = TRUE,
                                            full.names = TRUE, pattern = "^tissue_hires"),
                          json = list.files(data_dir ,recursive = TRUE,
                                            full.names = TRUE, pattern = "^scalefactors"))
  return(infoTable)
}

infoTable <- create_infoTable(st.dir, tissue = "Colon")

###### Scanning for metadata
load_ST_meta <- function(data.dir, flag) {
  if (length(list.files(data.dir, pattern = flag,
                        recursive = TRUE)) > 0) {
    meta.path <- list.files(data.dir, pattern = flag, 
                            full.names = TRUE, recursive=TRUE) 
    message("Loading metadata from ", meta.path)
    st.meta <- read_excel(meta.path)
  } else {
    message("No metadata found")
  }
  return(st.meta)
}

st.meta <- load_ST_meta(st.dir, flag="overview-A")

st.meta <- st.meta %>%
  dplyr::rename(sample_id = all_of("Slide ID")) %>%
  dplyr::arrange(sample_id) %>%
  select(!c("Median Genes per Spot","Median UMI Counts per Spot"))

#Subset metadata to keep only samples present in infoTable
samples.id <- list.dirs(paste0(st.dir,"/Colon/data/curated"), recursive=FALSE, full.names = FALSE)
st.meta <- st.meta[st.meta$sample_id %in% samples.id, ]

#Incorporate metadata and keep only the sections for which we have info
infoTable <- infoTable %>%
  bind_cols(st.meta) %>%
  filter(Group %in% c("HV","CD-IBS","CD+IBS")) %>%
  mutate(across(.cols = everything(), as.character))
```

**Loading healthy patients** For QC, in HV samples we removed all spots with less than 150 unique genes.

```{r}
infoTable.HV <- infoTable %>%
  filter(Group == "HV") 

se.hv <- ReadVisiumData(infoTable.HV)
se.hv <- SubsetSTData(se.hv, expression = nFeature_Spatial >= 150)
se.hv <- LoadImages(se.hv, image_height = 2000)
```

## Loading stereoscope dataq
Addressing potential issues in spot indexing
```{r}
load_stsc <- function(stsc_dir, se_obj, id_feature) {
  ##this version of the function allows for re-indexing of the ST barcodes based on the position of the section of interest in the input seurat
  #collection stereoscope outputs based on our seurat object
  stsc_sections_dirs <- str_subset(list.dirs(stsc_dir, recursive=TRUE, full.names = TRUE),
                                   pattern = paste(unique(se_obj@meta.data[[id_feature]]),
                                                   collapse = "|"))
  se_sections <- unique(se_obj@meta.data[[id_feature]])
  #reading results from those directories
  temp_stsc_res <- map_dfr(stsc_sections_dirs, function(section_dir) {
    section_id <- str_extract(section_dir,
                              pattern="V[[:digit:]]*[[:upper:]][[:digit:]]*[[:punct:]][[:digit:]]*[[:punct:]][[:upper:]][[:digit:]]") 
    file <- list.files(section_dir, pattern=".tsv",full.names = TRUE)
    message(file)
    section_res <- read_tsv(file) %>%
      rename(spot_id = `...1`) %>%
      mutate(spot_id = str_replace(spot_id, 
                                   "[[:digit:]]_[[:digit:]]*", 
                                   as.character(str_which(se_sections, 
                                                          section_id)))) %>%
      mutate(sample_id = section_id)
    
    return(section_res)
  }) 

  stsc_res <- temp_stsc_res 
  
  return(stsc_res)
}
```

```{r}
stsc.hv.res <- load_stsc(stsc_dir = paste0(stsc.dir),
                         se.hv, "sample_id")
```

## Comparing healthy patients
We want to compare the proportions of healthy patients in colon and healthy patients in rectum.

Loading stereoscope proportions to seurat
```{r}
add_stsc_to_seurat <- function(se_obj, stsc_res){
  #formatting stsc results
  adj_stsc <- stsc_res
  colnames(adj_stsc) <- colnames(adj_stsc) %>%
    gsub(" ","",.) %>%
    gsub("[[:punct:]]","_",.) 
  #generating key to keep original celltype name
  type_key <- colnames(stsc_res)
  names(type_key) <- colnames(adj_stsc)
  #adding information to seurat
  out_se <- AddMetaData(se_obj, metadata = adj_stsc)
  #setting output
  outs <- list(out_se, type_key)
  
  return(outs)
}
```

```{r}
se.hv.all <- add_stsc_to_seurat(se.hv, stsc.hv.res)
```

### Visualizing average proportions for each celltype

An approach to generating these plots will be to compute the average inferred proportions for all celltypes in each section under a specific group. In this case, compute the average proportions in HV sections, rectum vs colon

Create a plotting function

```{r}
avg_stsc_prps <- function(stsc_df, meta_df, meta_columns, grouping, celltype_colors){
  #creating meta stsc results
  meta_stsc <- stsc_df %>%
    inner_join(select(meta_df, 
                     all_of(meta_columns)),
              by = "sample_id") 
  #creating plot df
  plot_df <- meta_stsc %>%
    pivot_longer(cols = colnames(meta_stsc)[colnames(meta_stsc) %in% names(celltype_colors)],
                 names_to = "celltype", values_to = "prop") %>%
    group_by(.data[[grouping]], celltype, sample_id) %>%
    summarise(avg_prop = sum(prop)/n())
  #plotting
  plot <- ggplot(plot_df, aes(x = sample_id, y = avg_prop, fill = celltype)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = celltype_colors) +
    facet_grid(~ .data[[grouping]], scales ="free") +
    labs(title = paste0("Average stereoscope proportions in ", paste(sort(unique(meta_df$Group)), 
                                                                     collapse="|"), 
                        " patients"),
         x = "section_id",
         y = "average proportion") +
    theme(axis.text.x = element_text(angle = 90),
          plot.title = element_text(face = "bold"),
          strip.text.x = element_text(face = "bold"),
          legend.title = element_text(face = "bold"))
  
  return(plot)
}
```

Plotting
```{r}
celltype.colors <- setNames(Polychrome::light.colors(n=length(setdiff(colnames(stsc.hv.res),
                                                            c("sample_id","spot_id")))),
                            setdiff(colnames(stsc.hv.res),c("sample_id","spot_id")))
hv.plot <- avg_stsc_prps(stsc.hv.res, 
                         infoTable.HV,c("sample_id","Group","PIN","Tissue"),
                         "Tissue", celltype_colors = celltype.colors)
ggsave(hv.plot, filename = paste0(vis.dir,"/Proportions_Rectum_v_Colon_HV-curated-varGenes_2.png"),
       width = 8, height = 9)
```

# Metadata
```{r}
date()
sessionInfo()
```

