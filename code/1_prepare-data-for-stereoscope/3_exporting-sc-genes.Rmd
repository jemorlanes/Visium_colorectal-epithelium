---
title: "exporting_HV_curated_variableGenes"
author: "Javier Escudero"
date: "2023-07-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries
```{r}
rm(list=ls())

library(readxl)
library(tidyverse)
```

# Summary
The goal is to export the manually curated list of genes that Alex provided me with in the Excel *Figure 1 - top 20 genes with annotation*. I prepped the single cell data in the server previously, so I have already selected the celltypes and cells that will be included in the stereoscope run.

Thus, here I will just keep the variable genes for the celltypes that I grabbed previously. 

# Analysis
Loading the selected celltypes
```{r}
stsc.celltypes <- read_tsv("~/Documents/work/Helmsley_wLudvigL/data/single_cell/Colon_Alexandre/updated_sc/HV_mta_data.tsv") %>%
  pull(celltype) %>% unique()
```

Loading the data from the excel.
```{r}
excel.data <- read_excel(list.files("~/Documents/work/Helmsley_wLudvigL/data/single_cell/Colon_Alexandre/updated_sc",
                                 full.names = TRUE, pattern = ".xlsx"))
```

We didn't select all the celltypes, so let's just keep genes for the celltypes we have
```{r}
# getting genes and cluster (celltype)
gene.df <- select(excel.data, c(gene, cluster)) %>%
  mutate(cluster = as.character(cluster))
celltype.cluster <- as.data.frame(t(excel.data[21, c(9:37)])) %>%
  rownames_to_column(var = "cluster") %>%
  mutate(cluster = as.character(cluster)) %>%
  rename(celltype = V1) 

# keeping genes for celltypes that we want
gene.df <- inner_join(gene.df, celltype.cluster , by = "cluster")
```

We need to do some small adjustments to the formats of the names of the celltypes since, as always in this project, there are tiny differences that annoy me and are simply a small stone that gets in the way of a smooth analysis. I will end with backpain from carrying all of these small stones.
```{r}
# removing white spaces from everything
stsc.celltypes <- gsub(" ","", stsc.celltypes)
gene.df$celltype <- gsub(" ", "", gene.df$celltype)

# also I am noticing that the (R) and (C) flags are not present in this file of marker genes for the single cell data. So what I am going to do is remove that flag from the stereoscope celltypes and just work with the base name. Afterall, the cells for each celltype are already selected. Here it doesn't matter the actuall labelling, just that I keep the genes for all celltypes in gene.df
stsc.celltypes <- gsub("[[:punct:]][[:upper:]][[:punct:]]", "", stsc.celltypes)
```

Getting the genes
```{r}
variable.genes <- filter(gene.df, celltype %in% stsc.celltypes) %>%
  pull(gene)
```

Exporting
```{r}
write_lines(variable.genes, 
          file = "~/Documents/work/Helmsley_wLudvigL/data/single_cell/Colon_Alexandre/updated_sc/HV_curated_variableGenes.txt")
```

# Metadata
```{r}
date()
sessionInfo()
```








